services:
  # ---------------- Database Services ----------------
  db:
    image: postgres:16-alpine
    container_name: aura_postgres_db
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  mongo:
    image: mongo:7.0-jammy
    container_name: aura_mongo_db
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ---------------- API Services ----------------

  # 1. Entry Ingestor (Host: 8000)
  entry_ingestor_api:
    container_name: aura_ingestor_api
    build:
      context: .
      dockerfile: ./services/entry_ingestor/Dockerfile
    depends_on:
      db:
        condition: service_healthy
      mongo:
        condition: service_healthy
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
    volumes:
      # Mount code to /app/app (matches Dockerfile structure)
      - ./services/entry_ingestor/app:/app/app
      - ./shared:/app/shared
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    restart: unless-stopped

  # 2. NLP Agent (Host: 8001)
  nlp_agent_api:
    container_name: aura_nlp_agent_api
    build:
      context: . 
      dockerfile: ./services/nlp_agent/Dockerfile
    depends_on:
      db:
        condition: service_healthy
      mongo:
        condition: service_healthy
    ports:
      # Maps Host 8001 -> Container 8000 (NLP listens on 8000 internally)
      - "8001:8000" 
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
      - GOOGLE_APPLICATION_CREDENTIALS=/gcp-key.json
    volumes:
      - ./services/nlp_agent/app:/app/app
      - ./shared:/app/shared
      - ${GCP_KEYFILE_PATH}:/gcp-key.json:ro
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    restart: unless-stopped

  # 3. Auth Service (Host: 8002)
  auth_service:
    container_name: aura_auth_service
    build:
      context: .  # Builds from Root to access pyproject.toml
      dockerfile: ./services/auth_service/Dockerfile
    depends_on:
      db:
        condition: service_healthy
    ports:
      # Maps Host 8002 -> Container 8001 (Auth listens on 8001 internally)
      - "8002:8001"
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
    volumes:
      # Auth service seems to be flat (main.py at root of service folder)
      # So we mount directly to /app
      - ./services/auth_service:/app
      # If Auth needs shared:
      # - ./shared:/app/shared
    # Command matches the Dockerfile (main:app)
    command: uvicorn main:app --host 0.0.0.0 --port 8001 --reload
    restart: unless-stopped

volumes:
  postgres_data:
  mongo_data: